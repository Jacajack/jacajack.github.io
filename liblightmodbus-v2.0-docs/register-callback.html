<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.13"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>liblightmodbus: User-defined Modbus register callback function</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">liblightmodbus
   &#160;<span id="projectnumber">2.0</span>
   </div>
   <div id="projectbrief">A lightweight, cross-platform Modbus RTU library</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.13 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
</script>
<div id="main-nav"></div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

</div><!-- top -->
<div class="header">
  <div class="headertitle">
<div class="title">User-defined Modbus register callback function </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><dl class="section note"><dt>Note</dt><dd>This feature requires <code>REGISTER_CALLBACK</code> or <code>COIL_CALLBACK</code> module (see <a class="el" href="building.html">Building liblightmodbus</a>).</dd>
<dd>
Register callback function is still considered an experimental feature. In order to include this functionality during build process, please include <code>EXPERIMENTAL</code> module (see <a class="el" href="building.html">Building liblightmodbus</a>).</dd></dl>
<p>Liblightmodbus allows user to define his own register/coil callback function used for fetching register values instead of the <a class="el" href="structmodbusSlave.html#a087a68ac6cc2a32ffcabac619308c2a9">ModbusSlave::registers</a> <a class="el" href="structmodbusSlave.html#aaa1017b634e49e9f82bb8499ea51c7b0">ModbusSlave::coils</a> arrays. This feature can be helpful when implementing non-continuous register ranges that would otherwise mean huge waste of memory.</p>
<p>It is important to mention, that once callback function is enabled for registers, it has to handle input registers as well. The same goes for coils - the coil callback function has to handle discrete inputs as well. The register-array and register-callback system cannot coexist.</p>
<p>The pointer to the callback function (<a class="el" href="slave_8h.html#a6b267aaa861a9512b3a7a6b85afd9330">ModbusRegisterCallbackFunction</a>) should be stored in <a class="el" href="structmodbusSlave.html#ad1dbc7192d813f9e2edda3648d8c8413">ModbusSlave::registerCallback</a> before <a class="el" href="slave_8c.html#ab5704a5117a7970d5b3750c730b13ace">modbusSlaveInit()</a> is called. There's only one callback function for all data types and it should have following form:</p>
<div class="fragment"><div class="line">uint16_t callback( <a class="code" href="slave_8h.html#ace6c78a14a1fad1a78daac020fc59db4">ModbusRegisterQuery</a> query, <a class="code" href="lightmodbus_8h.html#a0110f2fb9e2687ce3d01f8c9160df7b9">ModbusDataType</a> datatype, uint16_t index, uint16_t value, <span class="keywordtype">void</span> *ctx )</div></div><!-- fragment --><p>The register/coil callback is an user-defined function determining if certain register or coil can be accessed and performing virtual register reads and writes. Below is an example of register callback function simply mapping register accesses to an array: </p><div class="fragment"><div class="line">uint16_t regs[16], iregs[16]; <span class="comment">//Holding registers and input registers arrays</span></div><div class="line">uint8_t writeacc[16]; <span class="comment">//Some write locks</span></div><div class="line"></div><div class="line">uint16_t rcallback( <a class="code" href="slave_8h.html#ace6c78a14a1fad1a78daac020fc59db4">ModbusRegisterQuery</a> query, <a class="code" href="lightmodbus_8h.html#a0110f2fb9e2687ce3d01f8c9160df7b9">ModbusDataType</a> datatype, uint16_t index, uint16_t value, <span class="keywordtype">void</span> *ctx )</div><div class="line">{</div><div class="line">    <span class="comment">//All can be read</span></div><div class="line">    <span class="keywordflow">if</span> ( query == <a class="code" href="slave_8h.html#ad7f9ffab0ad53209066bb7a7a668e792a68672dc5badc4bd15dd12c168502930d">MODBUS_REGQ_R_CHECK</a> ) <span class="keywordflow">return</span> 1;</div><div class="line"></div><div class="line">    <span class="comment">//writeacc determines if holding register can be written</span></div><div class="line">    <span class="keywordflow">if</span> ( query == <a class="code" href="slave_8h.html#ad7f9ffab0ad53209066bb7a7a668e792a0c01fdc7e834c204e355a160790b9932">MODBUS_REGQ_W_CHECK</a> ) <span class="keywordflow">return</span> writeacc[index];</div><div class="line"></div><div class="line">    <span class="comment">//Read</span></div><div class="line">    <span class="keywordflow">if</span> ( query == <a class="code" href="slave_8h.html#ad7f9ffab0ad53209066bb7a7a668e792a6b80870bbce488af3b4d8ae43e8b3308">MODBUS_REGQ_R</a> )</div><div class="line">    {</div><div class="line">        <span class="keywordflow">if</span> ( datatype == <a class="code" href="lightmodbus_8h.html#a122006b5ead222e63c4dc35b72054acfa399936691314c8b570aa8b8aa7742d0a">MODBUS_HOLDING_REGISTER</a> ) <span class="keywordflow">return</span> regs[index];</div><div class="line">        <span class="keywordflow">if</span> ( datatype == <a class="code" href="lightmodbus_8h.html#a122006b5ead222e63c4dc35b72054acfa8c7413b96e4656037480902e88d1d784">MODBUS_INPUT_REGISTER</a> ) <span class="keywordflow">return</span> iregs[index];</div><div class="line">    }</div><div class="line"></div><div class="line">    <span class="comment">//Write</span></div><div class="line">    <span class="keywordflow">if</span> ( query == <a class="code" href="slave_8h.html#ad7f9ffab0ad53209066bb7a7a668e792a3d41fd03043bb3eb8332e2fc55f208a1">MODBUS_REGQ_W</a> &amp;&amp; datatype == <a class="code" href="lightmodbus_8h.html#a122006b5ead222e63c4dc35b72054acfa399936691314c8b570aa8b8aa7742d0a">MODBUS_HOLDING_REGISTER</a> )</div><div class="line">        iregs[index] = value;</div><div class="line"></div><div class="line">    <span class="keywordflow">return</span> 0;</div><div class="line">}</div></div><!-- fragment --><p>The first function argument determines query type. Two types of register queries are distinguished - read/write requests (<a class="el" href="slave_8h.html#ad7f9ffab0ad53209066bb7a7a668e792a6b80870bbce488af3b4d8ae43e8b3308">MODBUS_REGQ_R</a>, <a class="el" href="slave_8h.html#ad7f9ffab0ad53209066bb7a7a668e792a3d41fd03043bb3eb8332e2fc55f208a1">MODBUS_REGQ_W</a>) and read/write access queries (<a class="el" href="slave_8h.html#ad7f9ffab0ad53209066bb7a7a668e792a68672dc5badc4bd15dd12c168502930d">MODBUS_REGQ_R_CHECK</a>, <a class="el" href="slave_8h.html#ad7f9ffab0ad53209066bb7a7a668e792a0c01fdc7e834c204e355a160790b9932">MODBUS_REGQ_W_CHECK</a>).</p>
<p>Upon reception of access query, the function shall return 1 if certain kind of access is granted to register of type determined by second argument of type <a class="el" href="lightmodbus_8h.html#a0110f2fb9e2687ce3d01f8c9160df7b9">ModbusDataType</a> and index determined by third argument. Otherwise 0 shall be returned.</p>
<p>If the callback function denies access to certain register, this results in slave device returning <a class="el" href="lightmodbus_8h.html#a7f8abd5db060712289592ea185bb1ac1ae02fd12fb65f8060a7662aa3ed69f0b3">MODBUS_EXCEP_SLAVE_FAILURE</a> exception frame. When callback function receives a read request it shall return 16-bit unsigned integer value of the register. If it receives a write request, the register should be written with value from the fourth parameter.</p>
<p>Liblightmodbus guarantees that no write requests will be ever made for discrete input and input register types. Neither will it request to read/write some register after the callback function denied certain kind of access for it. Access rights for registers will always be checked before reading/writing data. It's also guaranteed that the index argument will always be less than count of certain type registers set in <a class="el" href="slave_8h.html#aa2a76716e0f4937b0885b67bfb346d5d">ModbusSlave</a>.</p>
<dl class="section warning"><dt>Warning</dt><dd>Even though it's clearly stated what kind of queries will never be made by liblightmodbus internal Modbus functions, beware of your own Modbus functions. </dd></dl>
</div></div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.8.13
</small></address>
</body>
</html>
