<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.13"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>liblightmodbus: Basic usage</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">liblightmodbus
   &#160;<span id="projectnumber">2.0</span>
   </div>
   <div id="projectbrief">A lightweight, cross-platform Modbus RTU library</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.13 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
</script>
<div id="main-nav"></div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

</div><!-- top -->
<div class="header">
  <div class="headertitle">
<div class="title">Basic usage </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p>If you want to get started with liblightmodbus, you should probably start here. This page shows basic usage of the library and assumes you have a working copy of it.</p>
<p>If you don't, see <a class="el" href="building.html">Building liblightmodbus</a> or download a development package from the PPA.</p>
<p>The library consists of two independent parts. One contains all functions related with slave's tasks and the other functions related with master's tasks.</p>
<h2>Slave side</h2>
<p>The most important structure type on the slave side is <a class="el" href="slave_8h.html#aa2a76716e0f4937b0885b67bfb346d5d">ModbusSlave</a> which represents slave device's status and configuration. A pointer to such structure is passed to all the slave-related functions.</p>
<h3>Initialization</h3>
<p>In order to get started, you need to allocate some space for your slave's registers and coils. Two arrays will do just fine: </p><div class="fragment"><div class="line">uint16_t regs[16]; <span class="comment">//16 holding registers</span></div><div class="line">uint8_t coils[4];  <span class="comment">//32 coils</span></div></div><!-- fragment --><p>Next, the slave structure has to be initialized: </p><div class="fragment"><div class="line"><a class="code" href="structmodbusSlave.html">ModbusSlave</a> slave;</div><div class="line"></div><div class="line"><span class="comment">//Tell the library where registers and coils are</span></div><div class="line">slave.<a class="code" href="structmodbusSlave.html#a087a68ac6cc2a32ffcabac619308c2a9">registers</a> = regs;</div><div class="line">slave.<a class="code" href="structmodbusSlave.html#af59191e78cf6cce10cd39ea182412229">registerCount</a> = 16;</div><div class="line">slave.<a class="code" href="structmodbusSlave.html#aaa1017b634e49e9f82bb8499ea51c7b0">coils</a> = coils;</div><div class="line">slave.<a class="code" href="structmodbusSlave.html#a40084f5831aa6d59f0609c226b9b2b4a">coilCount</a> = 32;</div><div class="line"></div><div class="line"><span class="comment">//We don&#39;t have any input registers or discrete inputs</span></div><div class="line">slave.<a class="code" href="structmodbusSlave.html#a7cc02bd49660a98fb3a36c92e1e905bd">inputRegisterCount</a> = 0;</div><div class="line">slave.<a class="code" href="structmodbusSlave.html#a432889ab5611e3488a4d33489dd4aae0">discreteInputCount</a> = 0;</div><div class="line"></div><div class="line"><span class="comment">//Setup slave&#39;s address</span></div><div class="line">slave.<a class="code" href="structmodbusSlave.html#a666c952711acdde4922395e867031127">address</a> = 54;</div><div class="line"></div><div class="line">assert( <a class="code" href="slave_8c.html#ab5704a5117a7970d5b3750c730b13ace">modbusSlaveInit</a>( &amp;slave ) == <a class="code" href="lightmodbus_8h.html#a0e53935196f8baab23b35aaac466a1abafbb178df49063323a6dcbf03dd0d88d2">MODBUS_OK</a> );</div></div><!-- fragment --><p>Note the <a class="el" href="slave_8h.html#ab5704a5117a7970d5b3750c730b13ace">modbusSlaveInit</a> call. This is the function that actually initializes the structure for use. It shall be called before any other library function is used on the structure</p>
<h3>Processing requests</h3>
<p>Processing incoming requests is done using <a class="el" href="slave_8h.html#aaca489cb3c3242693d539c70da3f1251">modbusParseRequest</a> function. However, before calling it, the request needs to be loaded to <a class="el" href="structmodbusSlave.html#aa4cc16ac40b371be2b2179523b8ff75b">ModbusSlave::request</a>. Please see the example below. </p><div class="fragment"><div class="line"><a class="code" href="lightmodbus_8h.html#aa6575c769c8b11c39735b63657435993">ModbusError</a> err;</div><div class="line">uint8_t length;</div><div class="line">uint8_t frame[256];</div><div class="line"></div><div class="line"><span class="comment">//Get the incoming frame somehow</span></div><div class="line">read_from_serial_somehow( &amp;frame, &amp;length );</div><div class="line"></div><div class="line"><span class="comment">//Pass the frame to the library</span></div><div class="line">slave.<a class="code" href="structmodbusSlave.html#aa4cc16ac40b371be2b2179523b8ff75b">request</a>.<a class="code" href="structmodbusSlave.html#af9d77c3bff19196a3c194adf4cf23531">frame</a> = frame;</div><div class="line">slave.<a class="code" href="structmodbusSlave.html#aa4cc16ac40b371be2b2179523b8ff75b">request</a>.<a class="code" href="structmodbusSlave.html#ab401b648ffcefd59ce277821b2334353">length</a> = length; </div><div class="line">err = <a class="code" href="slave_8c.html#aaca489cb3c3242693d539c70da3f1251">modbusParseRequest</a>( &amp;slave );</div><div class="line"></div><div class="line"><span class="comment">//It is acceptable for slave to throw exceptions</span></div><div class="line">assert( err == <a class="code" href="lightmodbus_8h.html#a0e53935196f8baab23b35aaac466a1abafbb178df49063323a6dcbf03dd0d88d2">MODBUS_OK</a> || err == <a class="code" href="lightmodbus_8h.html#a0e53935196f8baab23b35aaac466a1abad3e2ae9d0e134d9043afcb2d887e383c">MODBUS_ERROR_EXCEPTION</a> );</div></div><!-- fragment --><p>This code causes the library to process the incoming request. Afterwards, the response from <a class="el" href="structmodbusSlave.html#a2a03374965cea9f13c5d17e7db0eb741">ModbusSlave::response</a> needs to be send back to master device. </p><div class="fragment"><div class="line"><span class="keywordtype">int</span> i;</div><div class="line"><span class="keywordflow">for</span> ( i = 0; i &lt; slave.<a class="code" href="structmodbusSlave.html#a2a03374965cea9f13c5d17e7db0eb741">response</a>.<a class="code" href="structmodbusSlave.html#ab401b648ffcefd59ce277821b2334353">length</a>; i++ )</div><div class="line">    serial_send_somehow( slave.<a class="code" href="structmodbusSlave.html#a2a03374965cea9f13c5d17e7db0eb741">response</a>.<a class="code" href="structmodbusSlave.html#af9d77c3bff19196a3c194adf4cf23531">frame</a>[i] );</div></div><!-- fragment --><h3>Cleaning up</h3>
<p>After you're done using the library, don't forget to clean up. You should call <a class="el" href="slave_8h.html#a3d57b09a41be5b434864da06607d13c6">modbusSlaveEnd</a> on your slave structure.</p>
<h2>Master side</h2>
<p>The most important structure type on the master side is <a class="el" href="master_8h.html#ad6537390cf78a40acb49beb2896c8290">ModbusMaster</a> which represents master device's status and configuration (like <a class="el" href="slave_8h.html#aa2a76716e0f4937b0885b67bfb346d5d">ModbusSlave</a> on the slave side). A pointer to such structure is passed to all the master-related functions.</p>
<h3>Initialization</h3>
<p>Unlike on save side, there's nothing more to be done apart from initializing the master structure with <a class="el" href="master_8h.html#aa103c294d6325feabb13b343bf2b6e2e">modbusMasterInit</a>. </p><div class="fragment"><div class="line"><a class="code" href="structmodbusMaster.html">ModbusMaster</a> master;</div><div class="line">assert( <a class="code" href="master_8c.html#aa103c294d6325feabb13b343bf2b6e2e">modbusMasterInit</a>( &amp;master ) == <a class="code" href="lightmodbus_8h.html#a0e53935196f8baab23b35aaac466a1abafbb178df49063323a6dcbf03dd0d88d2">MODBUS_OK</a> );</div></div><!-- fragment --><h3>Forming requests</h3>
<p>Request frames can be generated using <code>modbusBuildRequest**</code> functions. After each successful call, the new request frame will be written to <a class="el" href="structmodbusMaster.html#ab57061e09cac0c25d9c7e5225fb041e4">ModbusMaster::request</a>. </p><div class="fragment"><div class="line"><span class="comment">//Write 678 to 7th register of slave 54</span></div><div class="line">assert( modbusBuildRequest( &amp;master, 54, 7, 678 ) == <a class="code" href="lightmodbus_8h.html#a0e53935196f8baab23b35aaac466a1abafbb178df49063323a6dcbf03dd0d88d2">MODBUS_OK</a> );</div><div class="line"></div><div class="line"><span class="comment">//Send</span></div><div class="line"><span class="keywordflow">for</span> ( i = 0; i &lt; master.<a class="code" href="structmodbusMaster.html#ab57061e09cac0c25d9c7e5225fb041e4">request</a>.<a class="code" href="structmodbusMaster.html#a579ad7e6c6247024da2e63cf4a28cfbb">length</a>; i++ )</div><div class="line">    serial_send_somehow( master.<a class="code" href="structmodbusMaster.html#ab57061e09cac0c25d9c7e5225fb041e4">request</a>.<a class="code" href="structmodbusMaster.html#a87777251a9e4fcdec86f063b5231f6af">frame</a>[i] );</div></div><!-- fragment --><h3>Parsing responses</h3>
<p>The <a class="el" href="master_8h.html#afbcff357011e2f7c2eb0469ef80e0d7d">modbusParseResponse</a> function does the response parsing job on the master side. It needs to have the response frame provided in <a class="el" href="structmodbusMaster.html#a405ff7ecae677b06282ec883cc5d7179">ModbusMaster::response</a>. After successful parsing, the incoming data will be available in <a class="el" href="structmodbusMaster.html#a0e68533668809b672017f2591441bc9e">ModbusMaster::data</a> structure. If the slave had returned an exception, the exception details will be available in the <a class="el" href="structmodbusMaster.html#a23dc99278a95c0fd0841bc3bf1e2e0f9">ModbusMaster::exception</a> structure. </p><div class="fragment"><div class="line"><a class="code" href="lightmodbus_8h.html#aa6575c769c8b11c39735b63657435993">ModbusError</a> err;</div><div class="line">uint8_t length;</div><div class="line">uint8_t frame[256];</div><div class="line"></div><div class="line"><span class="comment">//Get the incoming frame somehow</span></div><div class="line">read_from_serial_somehow( &amp;frame, &amp;length );</div><div class="line"></div><div class="line"><span class="comment">//Pass the frame to the library</span></div><div class="line">master.<a class="code" href="structmodbusMaster.html#a405ff7ecae677b06282ec883cc5d7179">response</a>.<a class="code" href="structmodbusMaster.html#a87777251a9e4fcdec86f063b5231f6af">frame</a> = frame;</div><div class="line">master.<a class="code" href="structmodbusMaster.html#a405ff7ecae677b06282ec883cc5d7179">response</a>.<a class="code" href="structmodbusMaster.html#a579ad7e6c6247024da2e63cf4a28cfbb">length</a> = length;</div><div class="line">err = <a class="code" href="master_8c.html#afbcff357011e2f7c2eb0469ef80e0d7d">modbusParseResponse</a>( &amp;master );</div><div class="line"></div><div class="line"><span class="keywordflow">if</span> ( err == <a class="code" href="lightmodbus_8h.html#a0e53935196f8baab23b35aaac466a1abafbb178df49063323a6dcbf03dd0d88d2">MODBUS_OK</a> )</div><div class="line">{</div><div class="line">    <span class="comment">//Use the data</span></div><div class="line">    <span class="comment">//see ModbusMaster::data</span></div><div class="line">}</div><div class="line"><span class="keywordflow">else</span> <span class="keywordflow">if</span> ( err == <a class="code" href="lightmodbus_8h.html#a0e53935196f8baab23b35aaac466a1abad3e2ae9d0e134d9043afcb2d887e383c">MODBUS_ERROR_EXCEPTION</a> )</div><div class="line">{</div><div class="line">    <span class="comment">//Use the exception information</span></div><div class="line">    printf( <span class="stringliteral">&quot;slave threw an exception - %d\n&quot;</span>, master.<a class="code" href="structmodbusMaster.html#a23dc99278a95c0fd0841bc3bf1e2e0f9">exception</a>.<a class="code" href="structmodbusMaster.html#a7a70ed0cd9eb215ea5003a2cf0593796">code</a> );</div><div class="line">}</div><div class="line"><span class="keywordflow">else</span></div><div class="line">{</div><div class="line">    <span class="comment">//Handle the other errors</span></div><div class="line">    <span class="comment">//see ModbusError</span></div><div class="line">}</div></div><!-- fragment --><h3>Cleaning up</h3>
<p>After you're done using the library, don't forget to clean up. You should call <a class="el" href="master_8h.html#aee672157bcd8f786a54974305021860a">modbusMasterEnd</a> on your master structure.</p>
<h2>Examples</h2>
<p>Please see the contents of the <code>examples</code> directory. </p>
</div></div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.8.13
</small></address>
</body>
</html>
